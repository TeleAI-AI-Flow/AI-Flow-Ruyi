# AI-Flow-Ruyi (å¦‚æ„å¤§æ¨¡å‹)

<p align="center">
    <img src="assets/AI-Flow-Ruyi-logo.png" width="500" />
</p>

<p align="center">
        <a href="README.md">ä¸­æ–‡</a> &nbsp | &nbsp <a href="README_en.md">English</a>
        <br>
        ğŸ± <a href="https://github.com/TeleAI-AI-Flow/AI-Flow-Ruyi">GitHub</a> &nbsp&nbsp | &nbsp&nbsp ğŸ¤— <a href="https://huggingface.co/TeleAI-AI-Flow/AI-Flow-Ruyi-7B-Preview0704">Hugging Face</a>&nbsp&nbsp | &nbsp&nbspğŸ¤– <a href="https://www.modelscope.cn/models/TeleAI-AI-Flow/AI-Flow-Ruyi-7B-Preview0704/">ModelScope</a>&nbsp&nbsp | &nbsp&nbsp ğŸ“‘&nbsp <a href="https://www.arxiv.org/abs/2506.12479">Paper</a>
</p>

#### Long long ago...
> é¾™å®«ä¸­çè—ç€ä¸€æ ¹ç¥æ£’ï¼Œèƒ½å¤§èƒ½å°ï¼Œå˜åŒ–æ— ç©·ã€‚ä¸€æ—¥ï¼Œé¾™ç‹é—²æ¥æ— äº‹ï¼Œå¯¹ç€ç¥æ£’æ„Ÿæ…¨ï¼šâ€œä½ æœ‰å¦‚æ­¤ç¥é€šï¼Œè‹¥èƒ½åŠ©æˆ‘é¾™æ—åšäº›åˆ«çš„äº‹è¯¥å¤šå¥½ã€‚â€è¯éŸ³æœªè½ï¼Œç¥æ£’ç«Ÿå¼€å£åº”é“ï¼šâ€œæˆ‘å€’æœ‰ä¸ªä¸»æ„ï¼Œè¿™å˜åŒ–ä¹‹èƒ½ï¼Œè‹¥ç”¨æ¥å¸®ä¸–äººè§£å†³éš¾é¢˜...â€ è¯´å¹²å°±å¹²ï¼Œç¥æ£’ç¬é—´æ‘‡èº«ä¸€å˜ï¼ŒåŒ–ä½œä¸€ä¸ªç¥é€šå¹¿å¤§çš„â€œå¦‚æ„â€å¤§æ¨¡å‹ï¼Œèƒ½ä¾æ®é—®é¢˜çš„éš¾æ˜“ï¼Œè‡ªç”±ä¼¸ç¼©å…¶â€œèƒ½è€â€ã€‚é¾™ç‹è§çŠ¶å¤§å–œï¼šâ€œè¿™ä¸æ­£æ˜¯èƒ½åŠ©äººæ’å¿§è§£éš¾çš„â€˜å¦‚æ„â€™å®è´å—ï¼Ÿâ€é‚ä¸ºå…¶èµåâ€œå¦‚æ„â€ï¼Œæ´¾å®ƒå‰å¾€äººé—´æµä¸–åŠ©äººã€‚

## æ–°é—»

* ğŸ‰ğŸ‰[2025/7/14]ï¼šæ™ºä¼ ç½‘ï¼ˆAI Flowï¼‰è¢«å›½å†…çŸ¥åç§‘æŠ€åª’ä½“ã€Œ[æœºå™¨ä¹‹å¿ƒ](https://mp.weixin.qq.com/s/fiyb3LyJOd5mr9xzAsDZ4A)ã€æŠ¥é“ï¼
* ğŸ‰ğŸ‰[2025/7/4]ï¼šæ™ºä¼ ç½‘ï¼ˆAI Flowï¼‰è¢«å…¨çƒèµ„è®¯æœºæ„[Omdia](https://omdia.tech.informa.com/om137892/on-the-radar-teleai-brings-intelligence-to-the-network-edge-through-ai-flow)çº³å…¥çŸ­è¯„ï¼Œåˆ—ä¸ºç”Ÿæˆå¼ AI è½åœ°åº”ç”¨çš„â€œé‡ç‚¹è§‚å¯Ÿâ€ã€‚
* ğŸ‰ğŸ‰[2025/7/4]ï¼šå¦‚æ„-7Bé¢„è§ˆç‰ˆï¼ˆAI-Flow-Ruyi-7B-Previewï¼‰å‘å¸ƒ

## ä»‹ç»

**å¦‚æ„å¤§æ¨¡å‹ï¼ˆAI-Flow-Ruyiï¼‰** æ˜¯ä¸­å›½ç”µä¿¡äººå·¥æ™ºèƒ½ç ”ç©¶é™¢ (TeleAI) æ™ºä¼ ç½‘ï¼ˆAI Flowï¼‰å›¢é˜Ÿç ”å‘ï¼Œæ˜¯é¢å‘ä¸‹ä¸€ä»£â€œç«¯-è¾¹-äº‘â€æ¨¡å‹æœåŠ¡æ¶æ„çš„**åŒæºå®¶æ—æ¨¡å‹ï¼ˆFamilial Modelï¼‰** ã€‚å…¶æ ¸å¿ƒåœ¨äºå¤§å°æ¨¡å‹å…±äº«åŒæºå‚æ•°ï¼Œæ¨¡å‹èƒ½åŸºäºæ—©é€€å‡ºæœºåˆ¶ï¼Œæ ¹æ®é—®é¢˜å¤æ‚åº¦è°ƒç”¨ä¸åŒå‚æ•°è§„æ¨¡çš„åˆ†æ”¯æ¨¡å‹è¿›è¡Œå“åº”ã€‚å„åˆ†æ”¯æ—¢å¯ç‹¬ç«‹è¿è¡Œï¼Œåˆèƒ½ä¾æ‰˜åŒæºç‰¹æ€§å®ç°ä¿¡æ¯å…±äº«ä¸æ— ç¼åˆ‡æ¢ï¼Œç»“åˆç«¯-è¾¹-äº‘åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå®Œæˆå®¶æ—å¤§å°æ¨¡å‹ååŒï¼Œå®ç°æ¨¡å‹åˆ†å¸ƒå¼æ¨ç†æ•ˆç‡å¤§å¹…æå‡ã€‚

![](assets/ai-flow.png)
![](assets/ruyi_model.png)

## å¦‚æ„-7Bé¢„è§ˆç‰ˆ

ä¸ºäº†è®©ä¸šç•Œèƒ½äº²èº«ä½“éªŒèƒ½å¤Ÿè‡ªç”±ä¼¸ç¼©çš„â€œå®¶æ—æ¨¡å‹â€ï¼Œæˆ‘ä»¬å¼€æºäº†å¦‚æ„-7Bé¢„è§ˆç‰ˆï¼ˆAI-Flow-Ruyi-7B-Previewï¼‰ï¼Œä»¥å±•ç¤ºæˆ‘ä»¬åœ¨æŠ€æœ¯è½åœ°ä¸Šçš„å†³å¿ƒã€‚å¦‚æ„-7Bé¢„è§ˆç‰ˆï¼ˆAI-Flow-Ruyi-7B-Previewï¼‰äº7æœˆ4æ—¥å‘å¸ƒã€‚å…¶æœ€å¤§å‚æ•°é‡åˆ†æ”¯ä¸º7Bï¼Œå¯åˆ†åŒ–å‡ºå…·æœ‰ç­‰æ•ˆå‚æ•°é‡ä¸º3Bã€4Bã€5Bã€6Bçš„æ—©é€€å‡ºåˆ†æ”¯ã€‚å…¶ä¸­ï¼š
* 3Bã€4Båˆ†æ”¯èšç„¦ç®€å•å¯¹è¯åœºæ™¯ï¼Œå…¶ä¼˜åŠ¿åœ¨äºå“åº”é€Ÿåº¦å¿«ã€èµ„æºéœ€æ±‚ä½ï¼›
* 5Bã€6Båˆ†æ”¯åˆ™é’ˆå¯¹æ—¥å¸¸é€šç”¨ä»»åŠ¡åœºæ™¯ï¼Œåœ¨æ€§èƒ½ä¸å“åº”é€Ÿåº¦ä¹‹é—´å¯»æ±‚å¹³è¡¡ï¼›
* 7Båˆ†æ”¯ä¸»è¦ç”¨äºåº”å¯¹å¤æ‚é—®é¢˜ï¼Œåœ¨å¤šç§èƒ½åŠ›ç»´åº¦ä¸Šå±•ç°å‡ºè¾ƒä¸ºå…¨é¢çš„ç‰¹æ€§ï¼Œä½†ç›¸å¯¹è€Œè¨€å“åº”é€Ÿåº¦ç¨ç¼“ã€èµ„æºéœ€æ±‚ç•¥é«˜ã€‚

|ä½ç‚¹åºå·|æ—©é€€å‡ºä½ç½®|ç­‰æ•ˆæ¨¡å‹å¤§å°|å¯¹åº”åˆ†æ”¯ä»£å·|åœºæ™¯å®šä½|
|:-:|:-:|:-:|:-:|:-:|
|1|11å±‚|3B|AI-Flow-Ruyi-7B-E3B|ç®€å•å¯¹è¯|
|2|15å±‚|4B|AI-Flow-Ruyi-7B-E4B|ç®€å•å¯¹è¯|
|3|19å±‚|5B|AI-Flow-Ruyi-7B-E5B|æ—¥å¸¸ä»»åŠ¡|
|4|23å±‚|6B|AI-Flow-Ruyi-7B-E6B|æ—¥å¸¸ä»»åŠ¡|
|5|27å±‚|7B|AI-Flow-Ruyi-7B-E7B|å¤æ‚é—®é¢˜|

### è®­ç»ƒè¿‡ç¨‹

åœ¨è®­ç»ƒå¼€å§‹å‰ï¼Œæˆ‘ä»¬åŸºäºQwenå›¢é˜Ÿé¢„è®­ç»ƒçš„[Qwen2.5-7B](https://arxiv.org/abs/2412.15115)æ¨¡å‹ï¼ˆå…¶å·²åœ¨18ä¸‡äº¿é«˜è´¨é‡tokenä¸Šå®Œæˆé¢„è®­ç»ƒï¼‰ï¼Œå¯¹7Bä¸»åˆ†æ”¯è¿›è¡Œäº†å‚æ•°åˆå§‹åŒ–ï¼›å¯¹äºæ—©é€€å‡ºåˆ†æ”¯ï¼Œå…¶è§£ç å™¨å±‚é‡‡ç”¨æ—©é€€å‡ºä½ç½®çš„ä¸‹ä¸€å±‚å‚æ•°è¿›è¡Œåˆå§‹åŒ–ã€‚

å®Œæˆåˆå§‹åŒ–åï¼Œæˆ‘ä»¬é‡‡ç”¨**å¤šåˆ†æ”¯è”åˆé¢„è®­ç»ƒ**æ–¹æ³•ï¼Œåœ¨ç§æœ‰é«˜è´¨é‡æ•°æ®é›†ä¸Šè¿›è¡Œäº†çº¦4000äº¿tokençš„ç»§ç»­é¢„è®­ç»ƒï¼Œæ„å»ºå‡ºå¦‚æ„-7BåŸºåº§ï¼ˆAI-Flow-Ruyi-7B-Baseï¼‰ã€‚

éšåï¼Œæˆ‘ä»¬åŸºäºçº¦120ä¸‡æ¡é«˜è´¨é‡æŒ‡ä»¤æ•°æ®ï¼Œå¯¹å„åˆ†æ”¯è¿›è¡Œäº†**è”åˆæŒ‡ä»¤éµå¾ªå¾®è°ƒ**ï¼Œå¾—åˆ°å¦‚æ„-7Bé¢„è§ˆç‰ˆã€‚

### æ€§èƒ½è¯„æµ‹

æˆ‘ä»¬åŸºäº[OpenCompass](https://github.com/open-compass/opencompass)åŠå…¶å®˜æ–¹é…ç½®æ–‡ä»¶ï¼Œä»¥0-shotæ–¹å¼åœ¨å¤šä¸ªæ•°æ®é›†ä¸Šè¿›è¡Œè¯„æµ‹ã€‚è¯„æµ‹ç»“æœè¡¨æ˜ï¼Œ7Bä¸»åˆ†æ”¯åœ¨é€šç”¨ä»»åŠ¡æ€§èƒ½ä¸Šä¸Qwen2.5-7B-InstructåŸºæœ¬æŒå¹³ã€‚

<details>
<summary>é€šç”¨ä»»åŠ¡è¯„æµ‹</summary>

|æ¨¡å‹åç§°|MMLU|MMLU-Pro|CMMLU|ARC-c|BBH|å‡åˆ†|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|Qwen3-8B(think)|74.78|66.02|76.33|63.39|60.68|68.24|
|Qwen2.5-7B-Instruct|70.88|56.33|75.71|86.44|51.51|68.17|
|Llama-3.1-8B-Instruct|53.16|45.36|51.65|83.73|72.47|61.27|
|AI-Flow-Ruyi-7B-E7B<b>(ours)</b>|87.19|59.78|48.14|69.83|74.47|67.88|

</details>

<details>
<summary>ä»£ç ä»»åŠ¡è¯„æµ‹</summary>

|æ¨¡å‹åç§°|MBPP|HumanEval|LiveCodeBench|å‡åˆ†|
|:-:|:-:|:-:|:-:|:-:|
|Qwen3-8B(think)|78.60|84.76|63.10|75.49|
|Qwen2.5-7B-Instruct|70.82|84.15|34.55|63.17|
|Llama3.1-8B-Instruct|68.48|63.41|8.15|46.68|
|AI-Flow-Ruyi-7B-E7B<b>(ours)</b>|66.93|64.63|30.01|53.86|

</details>

<details>
<summary>STEMä»»åŠ¡è¯„æµ‹</summary>

|æ¨¡å‹åç§°|Math|GPQA|GSM-8K|å‡åˆ†|
|:-:|:-:|:-:|:-:|:-:|
|Qwen3-8B(think)|83.84|38.38|93.03|71.75|
|Qwen2.5-7B-Instruct|73.66|35.35|88.48|65.83|
|Llama3.1-8B-Instruct|49.22|25.25|85.82|53.43|
|AI-Flow-Ruyi-7B-E7B<b>(ours)</b>|44.94|24.75|81.65|50.45|

</details>


åŒæ—¶ï¼Œå„æ—©é€€å‡ºåˆ†æ”¯æ€§èƒ½å‘ˆç°å‡ºéšç­‰æ•ˆå‚æ•°é‡å•è°ƒé€’å¢çš„è¶‹åŠ¿ã€‚

|æ¨¡å‹åç§°|MMLU|MMLU-Pro|CMMLU|ARC-c|BBH|å‡åˆ†|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|AI-Flow-Ruyi-7B-E3B<b>(ours)</b>|66.93|44.70|19.80|40.00|32.29|40.74|
|AI-Flow-Ruyi-7B-E4B<b>(ours)</b>|78.86|48.60|26.51|58.98|41.98|50.99|
|AI-Flow-Ruyi-7B-E5B<b>(ours)</b>|75.34|49.13|33.91|65.76|64.48|57.72|
|AI-Flow-Ruyi-7B-E6B<b>(ours)</b>|84.58|53.06|33.94|73.22|47.33|58.43|
|AI-Flow-Ruyi-7B-E7B<b>(ours)</b>|87.19|59.78|48.14|69.83|74.47|67.88|

## ä½¿ç”¨

Step 1. åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ

```sh
conda create -n ruyi python=3.12
conda activate ruyi
```

Step 2. å…‹éš†æœ¬ä»“åº“è‡³æœ¬åœ°

```sh
git clone https://github.com/TeleAI-AI-Flow/AI-Flow-Ruyi.git
cd AI-Flow-Ruyi
```

Step 3. ç”±æºç å®‰è£…ï¼ˆPS: flash_attnç¼–è¯‘å®‰è£…è¾ƒæ…¢ï¼Œå»ºè®®ç§»æ­¥[å®˜æ–¹ä»“åº“](https://github.com/Dao-AILab/flash-attention/releases/tag/v2.7.4.post1)ä¸‹è½½whlæ‰‹åŠ¨å®‰è£…ï¼‰

```sh
pip install -e .
```

Step 4. ä¸‹è½½æ¨¡å‹æƒé‡

```sh
git clone https://www.modelscope.cn/TeleAI-AI-Flow/AI-Flow-Ruyi-7B-Preview0704.git models/AI-Flow-Ruyi-7B-Preview0704
```

Step 5. è¿è¡ŒDemo

```sh
python demo.py
```

<details>
<summary>æŸ¥çœ‹Demoä»£ç </summary>

```py
import torch
from ruyi.global_var import set_global_val
from transformers import GenerationConfig
from transformers import AutoModelForCausalLM, AutoTokenizer


model_path = f"models/AI-Flow-Ruyi-7B-Preview0704"
tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=True)
model = AutoModelForCausalLM.from_pretrained(model_path, trust_remote_code=True, attn_implementation='flash_attention_2', torch_dtype=torch.bfloat16).to('cuda')


generation_config = GenerationConfig(
    do_sample=True,                  
    top_k=30,                        
    top_p=0.95,                      
    temperature=0.6,                 
    repetition_penalty=1.2,          
    no_repeat_ngram_size=3,          
    max_new_tokens=8192
)

# è¾“å…¥æ–‡æœ¬
messages = [
    {"role": "user", "content": "ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚"},
]

# åº”ç”¨ chat_template æ¨¡æ¿
prompt = tokenizer.apply_chat_template(messages, tokenize=False, add_generation_prompt=True)
inputs = tokenizer(prompt, return_tensors="pt")

# æ¨¡å‹ç”Ÿæˆ
with torch.no_grad():
    # è®¾ç½®æ—©é€€å‡ºç‚¹
    # - 11: ç¬¬ä¸€ä¸ªæ—©é€€å‡ºç‚¹ï¼Œå¯¹åº”çº¦3B
    # - 15: ç¬¬äºŒä¸ªæ—©é€€å‡ºç‚¹ï¼Œå¯¹åº”çº¦4B
    # - 19: ç¬¬ä¸‰ä¸ªæ—©é€€å‡ºç‚¹ï¼Œå¯¹åº”çº¦5B
    # - 23: ç¬¬å››ä¸ªæ—©é€€å‡ºç‚¹ï¼Œå¯¹åº”çº¦6B
    # - 27: ç¬¬äº”ä¸ªæ—©é€€å‡ºç‚¹ï¼Œå¯¹åº”çº¦7B
    set_global_val("early_exit_point", 11)  

    output = model.generate(
        inputs["input_ids"].to('cuda'),
        generation_config=generation_config
    )

# è§£ç å¹¶æ‰“å°ç»“æœ
generated_text = tokenizer.decode(output[0], skip_special_tokens=False)
print(generated_text)
```

</details>

## å¼•ç”¨

```bibtex
@misc{an2025aiflowperspectivesscenarios,
      title={AI Flow: Perspectives, Scenarios, and Approaches}, 
      author={Hongjun An and Wenhan Hu and Sida Huang and Siqi Huang and Ruanjun Li and Yuanzhi Liang and Jiawei Shao and Yiliang Song and Zihan Wang and Cheng Yuan and Chi Zhang and Hongyuan Zhang and Wenhao Zhuang and Xuelong Li},
      year={2025},
      eprint={2506.12479},
      archivePrefix={arXiv},
      primaryClass={cs.AI},
      url={https://arxiv.org/abs/2506.12479}, 
}
```
